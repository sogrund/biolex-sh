<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personenlexikon f√ºr Schleswig-Holstein</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap');
    body { font-family: 'Prompt', sans-serif; }
    .banner-blue { background-color: #071E49; }
    
.marker-blue, .marker-red {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid white;
}

.marker-blue {
    background: #071E49; /* Geburtsort */
}

.marker-red {
    background: #d9534f; /* Sterbeort */
}
  </style>
  
</head>

<body class="bg-gray-100">

<!-- BANNER -->
<header class="banner-blue w-full px-6 py-10 shadow-lg relative">
  <button id="menuBtn"
          class="md:hidden absolute left-6 top-6 w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow">
      <div class="space-y-1">
        <div class="w-6 h-0.5 bg-black"></div>
        <div class="w-6 h-0.5 bg-black"></div>
        <div class="w-6 h-0.5 bg-black"></div>
      </div>
  </button>

  <h1 class="text-4xl mb-4 text-white">Personenlexikon f√ºr Schleswig-Holstein</h1>

  <p class="text-white leading-relaxed mb-6">
    Suchen Sie in √ºber 1800 Eintr√§gen des in 13 B√§nden zwischen 1971 und 2011 erschienenen
    <em>Biographischen Lexikons f√ºr Schleswig-Holstein und L√ºbeck.</em> <br>
      Sie finden hier Kurzbiografien zu bedeutenden Personen und Familien Schleswig-Holsteins, 
      darunter K√ºnstler, Wissenschaftler, Politiker, Geistliche, Unternehmer und viele weitere, die in Schleswig-Holstein geboren wurden oder ma√ügeblich gewirkt haben.
  </p>

  <input id="searchInput" type="text"
         placeholder="Suche nach Name, Ort ‚Ä¶"
         class="w-full md:w-1/2 px-4 py-3 rounded-xl border border-gray-300" />
</header>

<!-- MOBILE OVERLAY -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-30"></div>

<!-- PAGE WRAPPER -->
<div class="flex gap-6 items-start px-4 w-full">

  <!-- SIDEBAR -->
  <aside id="sidebar"
         class="w-72 bg-white shadow h-screen p-4 overflow-y-auto
                fixed md:static top-0 left-0 z-40 transform -translate-x-full md:translate-x-0
                transition-transform duration-300">

    <h2 class="text-xl font-semibold mb-4">üîç Filter</h2>

    <!-- Geburtsort -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Geburtsort</summary>
      <div id="filterGeburtsort" class="mt-2 space-y-1"></div>
    </details>

    <!-- Sterbeort -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Sterbeort</summary>
      <div id="filterSterbeort" class="mt-2 space-y-1"></div>
    </details>

    <!-- Geburtsdatum -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Geburtsdatum (Jahre)</summary>
      <div class="mt-2">
        <label>von</label>
        <input id="birthYearMin" type="number" class="w-full border rounded p-1 mb-2">
        <label>bis</label>
        <input id="birthYearMax" type="number" class="w-full border rounded p-1">
      </div>
    </details>

    <!-- Sterbedatum -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Sterbedatum (Jahre)</summary>
      <div class="mt-2">
        <label>von</label>
        <input id="deathYearMin" type="number" class="w-full border rounded p-1 mb-2">
        <label>bis</label>
        <input id="deathYearMax" type="number" class="w-full border rounded p-1">
      </div>
    </details>

  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-4 md:p-6 relative z-0">

    <div id="map" class="w-full h-96 rounded-xl shadow my-6"></div>

    <!-- View Switch -->
    <div class="flex gap-2 mb-4 justify-end">
      <button id="cardViewBtn"
              class="px-4 py-2 rounded-xl border border-gray-400 active-btn">
        Kartenansicht
      </button>
      <button id="tableViewBtn"
              class="px-4 py-2 rounded-xl border border-gray-400">
        Tabellenansicht
      </button>
    </div>

    <style>
      .active-btn { 
        @apply text-white; 
        background-color: #e11d48; 
     } 
    </style>  
    
    <!-- Cards -->
    <div id="cardContainer"
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"></div>

    <!-- Table -->
    <div id="tableContainer" class="overflow-x-auto hidden mb-10">
      <table class="min-w-full bg-white shadow rounded-xl overflow-hidden">
        <thead class="bg-gray-200">
        <tr>
          <th class="px-4 py-2 text-left">Name</th>
          <th class="px-4 py-2">Geburtsdatum</th>
          <th class="px-4 py-2">Geburtsort</th>
          <th class="px-4 py-2">Sterbedatum</th>
          <th class="px-4 py-2">Sterbeort</th>
          <th class="px-4 py-2">Quelle</th>
          <th class="px-4 py-2">GND</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  </main>
</div>

<!-- LEAFLET JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ---------------- Sidebar mobile toggle ---------------- */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const menuBtn = document.getElementById("menuBtn");

menuBtn.onclick = () => {
  sidebar.classList.remove("-translate-x-full");
  overlay.classList.remove("hidden");
  setTimeout(() => map.invalidateSize(), 350);
};

overlay.onclick = () => {
  sidebar.classList.add("-translate-x-full");
  overlay.classList.add("hidden");
  setTimeout(() => map.invalidateSize(), 350);
};

/* ---------------- CSV laden ---------------- */
const csvUrl = "data.csv";
let data = [];

Papa.parse(csvUrl, {
  download: true,
  header: true,
  skipEmptyLines: true,   // <<< WICHTIG: Leerzeilen entfernen!
  complete: r => {
    data = r.data.filter(row => row.Name && row.Name.trim() !== "");
    applyFilters();
  }
});

/* ---------------- Filter State ---------------- */
let activeFilters = {
  sterbeorte: new Set(),
  geburtsorte: new Set(),
  search: "",
  deathMin: null,
  deathMax: null,
  birthMin: null,
  birthMax: null
};

/* Search */
document.getElementById("searchInput").addEventListener("input", e => {
  activeFilters.search = e.target.value.toLowerCase();
  applyFilters();
});

/* Input fields */
["deathYearMin","deathYearMax","birthYearMin","birthYearMax"].forEach(id=>{
  document.getElementById(id).addEventListener("input", e=>{
    activeFilters[id.replace("Year","")] = e.target.value;
    applyFilters();
  });
});

/* ---------------- Facetten aktualisieren ---------------- */
function updateFacetFilters(filtered) {
  function fillFacet(id, field, activeSet) {
    const div = document.getElementById(id);
    const counts = {};
    filtered.forEach(r => {
      if (r[field]) counts[r[field]] = (counts[r[field]] || 0) + 1;
    });
    div.innerHTML = Object.entries(counts)
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 12)
      .map(([place,count]) => `
        <label>
          <input type="checkbox" value="${place}" ${activeSet.has(place)?"checked":""}>
          ${place} <span class="text-sm text-gray-500">(${count})</span>
        </label>
      `).join("<br>");
    div.querySelectorAll("input").forEach(cb => {
      cb.addEventListener("change", () => {
        cb.checked ? activeSet.add(cb.value) : activeSet.delete(cb.value);
        applyFilters();
      });
    });
  }

  fillFacet("filterSterbeort", "Sterbeort", activeFilters.sterbeorte);
  fillFacet("filterGeburtsort", "Geburtsort", activeFilters.geburtsorte);
}

/* ---------------- Filter Logik ---------------- */
function applyFilters() {
  let rows = data.filter(r => {
    if (activeFilters.search) {
      const s = activeFilters.search;
      if (!Object.values(r).some(v => String(v).toLowerCase().includes(s))) return false;
    }
    if (activeFilters.sterbeorte.size && !activeFilters.sterbeorte.has(r.Sterbeort)) return false;
    if (activeFilters.geburtsorte.size && !activeFilters.geburtsorte.has(r.Geburtsort)) return false;
    const d = r.Sterbedatum ? parseInt(r.Sterbedatum.substring(0,4)) : null;
    const b = r.Geburtsdatum ? parseInt(r.Geburtsdatum.substring(0,4)) : null;
    if (activeFilters.deathMin && d < activeFilters.deathMin) return false;
    if (activeFilters.deathMax && d > activeFilters.deathMax) return false;
    if (activeFilters.birthMin && b < activeFilters.birthMin) return false;
    if (activeFilters.birthMax && b > activeFilters.birthMax) return false;
    return true;
  });

  updateFacetFilters(rows);
  renderCards(rows);
  renderTable(rows);
  renderMap(rows);
}

/* ---------------- GND link helper ---------------- */
function gndLink(gnd) {
  if (!gnd) return "";
  const url = `https://explore.gnd.network/search?term=${encodeURIComponent(gnd)}&rows=25`;
  return `<a href="${url}" target="_blank" class="text-blue-600 underline">${gnd}</a>`;
}
  
/* ---------------- Cards ---------------- */
function renderCards(rows) {
  const cards = document.getElementById("cardContainer");

  cards.innerHTML = rows.map(r => `
    <div class="bg-white p-4 shadow rounded-xl">
    
<a href="detail.html?id=${r.GND}" class="text-rose-600 text-xl underline">
          ${r.Name}
        </a>
        <p><strong>Geburtsdatum:</strong> ${r.Geburtsdatum}</p>
        <p><strong>Geburtsort:</strong> ${r.Geburtsort}</p>
        <p><strong>Sterbedatum:</strong> ${r.Sterbedatum}</p>
        <p><strong>Sterbeort:</strong> ${r.Sterbeort}</p>
        <p><strong>Quelle:</strong> ${r.Quelle}</p>
        <p><strong>GND:</strong> ${gndLink(r.GND)}</p>

        <p class="mt-2 text-sm text-gray-700">${r.Biografie || ""}</p>
      </div>

    </div>
  `).join("");
}
    
/* ---------------- Table ---------------- */
function renderTable(rows) {
  document.getElementById("tableBody").innerHTML = rows.map(r => `
    <tr class="border-b">
      <td class="px-4 py-2">
        <a href="detail.html?id=${r.GND}" class="text-rose-600 underline">${r.Name}</a>
      </td>
      <td class="px-4 py-2">${r.Geburtsdatum}</td>
      <td class="px-4 py-2">${r.Geburtsort}</td>
      <td class="px-4 py-2">${r.Sterbedatum}</td>
      <td class="px-4 py-2">${r.Sterbeort}</td>
      <td class="px-4 py-2">${r.Quelle}</td>
      <td class="px-4 py-2">${gndLink(r.GND)}</td>
    </tr>
  `).join("");
}

/* ---------------- Map ---------------- */
const map = L.map("map").setView([54.5, 9.5], 7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
setTimeout(() => map.invalidateSize(), 300);

/* MAP LEGEND */
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "bg-white p-3 rounded shadow text-sm");
  div.innerHTML = `
    <div class="flex items-center gap-2 mb-1">
      <span class="inline-block w-3 h-3 bg-blue-600 rounded-full"></span>Geburtsort
    </div>
    <div class="flex items-center gap-2">
      <span class="inline-block w-3 h-3 bg-rose-600 rounded-full"></span>Sterbeort
    </div>
  `;
  return div;
};
legend.addTo(map);

const birthCluster = L.markerClusterGroup();
const deathCluster = L.markerClusterGroup();
map.addLayer(birthCluster);
map.addLayer(deathCluster);

const birthIcon = L.divIcon({
  className: "marker-blue"
});

const deathIcon = L.divIcon({
  className: "marker-red"
});


async function geocode(place) {
  if (!place) return null;
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
  const r = await fetch(url);
  const j = await r.json();
  if (j && j[0]) return [parseFloat(j[0].lat), parseFloat(j[0].lon)];
  return null;
}

async function renderMap(rows) {
  birthCluster.clearLayers();
  deathCluster.clearLayers();
  for (const p of rows) {
    if (p.Geburtsort) {
      const loc = await geocode(p.Geburtsort);
      if (loc)
        birthCluster.addLayer(L.marker(loc, {icon: birthIcon}).bindPopup(`<b>${p.Name}</b><br>Geburtsort: ${p.Geburtsort}`));
    }
    if (p.Sterbeort) {
      const loc = await geocode(p.Sterbeort);
      if (loc)
        deathCluster.addLayer(L.marker(loc, {icon: deathIcon}).bindPopup(`<b>${p.Name}</b><br>Sterbeort: ${p.Sterbeort}`));
    }
  }
  setTimeout(() => map.invalidateSize(), 200);
}

/* ---------------- View Switch ---------------- */
const cardBtn = document.getElementById('cardViewBtn');
const tableBtn = document.getElementById('tableViewBtn');

function setActive(button) {
  // Buttons
  cardBtn.classList.remove('active-btn','border-gray-400','border');
  tableBtn.classList.remove('active-btn','border-gray-400','border');
  cardBtn.classList.add('border','border-gray-400');
  tableBtn.classList.add('border','border-gray-400');
  button.classList.add('active-btn');

  // Container
  const cardContainer = document.getElementById('cardContainer');
  const tableContainer = document.getElementById('tableContainer');
  if(button === cardBtn){
    cardContainer.classList.remove('hidden');
    tableContainer.classList.add('hidden');
  } else {
    cardContainer.classList.add('hidden');
    tableContainer.classList.remove('hidden');
  }
}

// Event Listener
cardBtn.addEventListener('click', () => setActive(cardBtn));
tableBtn.addEventListener('click', () => setActive(tableBtn));

// Default
setActive(cardBtn);
</script>

</body>
</html>

