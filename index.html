<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personenlexikon f√ºr Schleswig-Holstein</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
  @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap');
  body { font-family: 'Prompt', sans-serif; }
  .card-text { color: rgb(7,30,73); }
  .text-pink { color: rgb(197,0,86); }
    .banner-blue {
      background-color: #071E49; /* RGB 7,30,73  ‚Üí entspricht Pantone 289c */
    }
  </style>
</head>
  
<!-- BANNER OBEN VOLLBREITE -->
<header class="banner-blue w-full px-6 py-10 shadow-lg">
  <h1 class="text-4xl mb-4 text-white">Personenlexikon f√ºr Schleswig-Holstein</h1>

  <p class="text-white w-full max-w-3xl leading-relaxed mb-6">
    Suchen Sie in √ºber 1800 Eintr√§gen des in 13 B√§nden zwischen 1971 und 2011 erschienenen <em>Biographischen Lexikons f√ºr Schleswig-Holstein und L√ºbeck</em>. Sie finden hier Kurzbiografien 
    zu bedeutenden Personen und Familien Schleswig-Holsteins, darunter K√ºnstler, Wissenschaftler, Politiker, Geistliche, Unternehmer und viele weitere, die in Schleswig-Holstein geboren wurden
    oder ma√ügeblich gewirkt haben.
  </p>

  <!-- Search field INSIDE banner -->
  <input id="searchInput" type="text" placeholder="Suche nach Name, Ort ‚Ä¶"
        class="w-full md:w-1/2 px-4 py-3 rounded-xl border border-gray-300" />
</header>
  
<!-- Layout nach dem Banner -->  
  <body class="bg-gray-100">

<div class="flex">
  <!-- Sidebar -->
  <aside class="w-72 bg-white shadow h-screen p-4 overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4">üîç Filter</h2>

   <!-- Geburtsort -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Geburtsort</summary>
      <div id="filterGeburtsort" class="mt-2 space-y-1"></div>
    </details>   
    
    <!-- Sterbeort -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Sterbeort</summary>
      <div id="filterSterbeort" class="mt-2 space-y-1"></div>
    </details>

   <!-- Geburtsdatum -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Geburtsdatum (Jahre)</summary>
      <div class="mt-2">
        <label>von</label>
        <input id="birthYearMin" type="number" class="w-full border rounded p-1 mb-2">
        <label>bis</label>
        <input id="birthYearMax" type="number" class="w-full border rounded p-1">
      </div>
    </details>  

    <!-- Sterbedatum -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Sterbedatum (Jahre)</summary>
      <div class="mt-2">
        <label>von</label>
        <input id="deathYearMin" type="number" class="w-full border rounded p-1 mb-2">
        <label>bis</label>
        <input id="deathYearMax" type="number" class="w-full border rounded p-1">
      </div>
    </details>

  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6">

    <!-- Map -->
    <div id="map" class="w-full h-96 mb-10 rounded-xl shadow"></div>

    <!-- View Buttons -->
<div class="flex gap-2 mb-4">
  <button id="cardViewBtn" class="px-4 py-2 rounded-xl border border-gray-400 active-btn">Kartenansicht</button>
  <button id="tableViewBtn" class="px-4 py-2 rounded-xl border border-gray-400">Tabellenansicht</button>
</div>

<style>
  /* Aktive Button-Farbe Pink CMYK 10/100/55/0 -> #E60099 */
  .active-btn {
    @apply text-white; /* Text wei√ü */
    background-color: #E60099;
  }
</style>

<script>
  const cardBtn = document.getElementById('cardViewBtn');
  const tableBtn = document.getElementById('tableViewBtn');

  function setActive(button) {
    // Alle Buttons inaktiv machen
    cardBtn.classList.remove('active-btn', 'bg-blue-600', 'border-gray-400', 'border');
    tableBtn.classList.remove('active-btn', 'bg-blue-600', 'border-gray-400', 'border');

    // Zust√§nde zur√ºcksetzen
    cardBtn.classList.add('border', 'border-gray-400');
    tableBtn.classList.add('border', 'border-gray-400');

    // Aktiven Button setzen
    button.classList.add('active-btn');
  }

  // Event Listener
  cardBtn.addEventListener('click', () => setActive(cardBtn));
  tableBtn.addEventListener('click', () => setActive(tableBtn));

  // Standardm√§√üig Kartenansicht aktiv
  setActive(cardBtn);
</script>
  
    <!-- Cards -->
    <div id="cardContainer"
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"></div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow rounded-xl overflow-hidden">
        <thead class="bg-gray-200">
        <tr>
          <th class="px-4 py-2 text-left">Name</th>
          <th class="px-4 py-2 text-left">Geburtstag</th>
          <th class="px-4 py-2 text-left">Geburtsort</th>
          <th class="px-4 py-2 text-left">Sterbedatum</th>
          <th class="px-4 py-2 text-left">Sterbeort</th>
           <th class="px-4 py-2 text-left">Quelle</th>
          <th class="px-4 py-2 text-left">GND</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  </main>
</div>


<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>


<script>
/* ---------------------------
   CSV LADEN
---------------------------- */
const csvUrl = "data.csv";
let data = [];

Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    data = results.data;
    applyFilters();
  }
});


/* ---------------------------
   FILTERS + FACETTEN
---------------------------- */
let activeFilters = {
  sterbeorte: new Set(),
  geburtsorte: new Set(),
  search: "",
  deathMin: null,
  deathMax: null,
  birthMin: null,
  birthMax: null
};

document.getElementById("searchInput").addEventListener("input", e => {
  activeFilters.search = e.target.value.toLowerCase();
  applyFilters();
});

document.getElementById("deathYearMin").addEventListener("input", e => { activeFilters.deathMin = e.target.value; applyFilters(); });
document.getElementById("deathYearMax").addEventListener("input", e => { activeFilters.deathMax = e.target.value; applyFilters(); });
document.getElementById("birthYearMin").addEventListener("input", e => { activeFilters.birthMin = e.target.value; applyFilters(); });
document.getElementById("birthYearMax").addEventListener("input", e => { activeFilters.birthMax = e.target.value; applyFilters(); });


function updateFacetFilters(filtered) {
  const fillFacet = (id, field, activeSet) => {
    const div = document.getElementById(id);
    const counts = {};
    filtered.forEach(row => {
      if (row[field]) counts[row[field]] = (counts[row[field]] || 0) + 1;
    });

    div.innerHTML = Object.entries(counts)
      .sort((a,b) => b[1]-a[1])
      .slice(0, 12)
      .map(([place,count]) => `
        <label>
          <input type="checkbox" value="${place}" ${activeSet.has(place)?"checked":""}>
          ${place} <span class="text-sm text-gray-500">(${count})</span>
        </label>
      `)
      .join("<br>");

    div.querySelectorAll("input").forEach(cb => {
      cb.addEventListener("change", () => {
        cb.checked ? activeSet.add(cb.value) : activeSet.delete(cb.value);
        applyFilters();
      });
    });
  };

  fillFacet("filterSterbeort", "Sterbeort", activeFilters.sterbeorte);
  fillFacet("filterGeburtsort", "Geburtsort", activeFilters.geburtsorte);
}

/* ---------------------------
   FILTER LOGIK
---------------------------- */
function applyFilters() {
  let rows = data.filter(row => {

    // Search
    if (activeFilters.search) {
      const s = activeFilters.search;
      if (!Object.values(row).some(v => String(v).toLowerCase().includes(s))) return false;
    }

    // Facetten
    if (activeFilters.sterbeorte.size &&
        !activeFilters.sterbeorte.has(row.Sterbeort)) return false;

    if (activeFilters.geburtsorte.size &&
        !activeFilters.geburtsorte.has(row.Geburtsort)) return false;

    // Year filters
    const dYear = row.Sterbedatum ? parseInt(row.Sterbedatum.substring(0,4)) : null;
    const bYear = row.Geburtstag ? parseInt(row.Geburtstag.substring(0,4)) : null;

    if (activeFilters.deathMin && dYear < activeFilters.deathMin) return false;
    if (activeFilters.deathMax && dYear > activeFilters.deathMax) return false;
    if (activeFilters.birthMin && bYear < activeFilters.birthMin) return false;
    if (activeFilters.birthMax && bYear > activeFilters.birthMax) return false;

    return true;
  });

  updateFacetFilters(rows);
  renderCards(rows);
  renderTable(rows);
  renderMap(rows);
}

// Umschalten der Ansicht
const cardContainer = document.getElementById("cardContainer");
const tableContainer = document.getElementById("tableContainer");


document.getElementById("cardViewBtn").onclick = () => {
cardContainer.classList.remove("hidden");
tableContainer.classList.add("hidden");
};


document.getElementById("tableViewBtn").onclick = () => {
cardContainer.classList.add("hidden");
tableContainer.classList.remove("hidden");
};
  
/* ---------------------------
   CARDS
---------------------------- */
  function gndLink(gnd) {
  if (!gnd || gnd.trim() === "") return "";
  const url = `https://explore.gnd.network/${encodeURIComponent(gnd)}`;
  return `<a href="${url}" target="_blank" class="text-blue-600 underline">${gnd}</a>`;  
}
  function renderCards(rows) {
  document.getElementById("cardContainer").innerHTML = rows.map(row => `
    <div class="bg-white p-4 shadow rounded-xl text-blue-800">
      <a href="detail.html?id=${row.GND}" class="text-pink-700 text-xl font-bold underline">
        ${row.Name}
      </a>
      <p><strong>Geburtstag:</strong> ${row.Geburtstag}</p>
      <p><strong>Geburtsort:</strong> ${row.Geburtsort}</p>
      <p><strong>Sterbedatum:</strong> ${row.Sterbedatum}</p>
      <p><strong>Sterbeort:</strong> ${row.Sterbeort}</p>
      <p><strong>Quelle Biolex:</strong> ${row.Quelle}</p>
      <p><strong>GND:</strong> ${gndLink(row.GND)}</p>
      <p class="mt-2 text-sm text-gray-700">${row.Biografie || ""}</p>
    </div>
  `).join("");
}


/* ---------------------------
   TABLE
---------------------------- */
  function gndLink(gnd) {
  if (!gnd || gnd.trim() === "") return "";
  const url = `https://explore.gnd.network/search?term=${encodeURIComponent(gnd)}&rows=25`;
  return `<a href="${url}" target="_blank" class="text-blue-600 underline">${gnd}</a>`;
}
  function renderTable(rows) {
  document.getElementById("tableBody").innerHTML = rows.map(r => `
    <tr class="border-b">
      <td class="px-4 py-2">
        <a href="detail.html?id=${r.GND}" class="text-pink-700 underline font-semibold">
          ${r.Name}
        </a>
      </td>
      <td class="px-4 py-2">${r.Geburtstag}</td>
      <td class="px-4 py-2">${r.Geburtsort}</td>
      <td class="px-4 py-2">${r.Sterbedatum}</td>
      <td class="px-4 py-2">${r.Sterbeort}</td>
      <td class="px-4 py-2">${r.Quelle}</td>
      <td class="px-4 py-2">${gndLink(r.GND)}</td>
    </tr>
  `).join("");
}


/* ---------------------------
   MAP
---------------------------- */
const map = L.map("map").setView([54.5, 9.5], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "¬© OpenStreetMap"
}).addTo(map);

  // -------------------------------------
// MAP LEGEND
// -------------------------------------
const legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  const div = L.DomUtil.create("div", "bg-white p-3 rounded shadow text-sm");

  div.innerHTML = `
    <div class="flex items-center gap-2 mb-1">
      <span class="inline-block w-3 h-3 bg-blue-600 rounded-full"></span>
      Geburtsort
    </div>
    <div class="flex items-center gap-2">
      <span class="inline-block w-3 h-3 bg-red-600 rounded-full"></span>
      Sterbeort
    </div>
  `;

  return div;
};

legend.addTo(map);


const birthCluster = L.markerClusterGroup();
const deathCluster = L.markerClusterGroup();
map.addLayer(birthCluster);
map.addLayer(deathCluster);

const birthIcon = new L.Icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
});

const deathIcon = new L.Icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
});

async function geocode(place) {
  if (!place) return null;
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
  const r = await fetch(url);
  const j = await r.json();
  if (j && j[0]) return [parseFloat(j[0].lat), parseFloat(j[0].lon)];
  return null;
}

async function renderMap(rows) {
  birthCluster.clearLayers();
  deathCluster.clearLayers();

  for (const p of rows) {
    if (p.Geburtsort) {
      const loc = await geocode(p.Geburtsort);
      if (loc)
        birthCluster.addLayer(
          L.marker(loc, {icon: birthIcon}).bindPopup(`<b>${p.Name}</b><br>Geburtsort: ${p.Geburtsort}`)
        );
    }
    if (p.Sterbeort) {
      const loc = await geocode(p.Sterbeort);
      if (loc)
        deathCluster.addLayer(
          L.marker(loc, {icon: deathIcon}).bindPopup(`<b>${p.Name}</b><br>Sterbeort: ${p.Sterbeort}`)
        );
    }
  }
}

</script>

</body>
</html>
