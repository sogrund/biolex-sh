<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personenlexikon Schleswig-Holstein</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

</head>
<body class="bg-gray-100">

<div class="flex">

  <!-- Sidebar -->
  <aside class="w-72 bg-white shadow h-screen p-4 overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4">üîç Filter</h2>

    <!-- Sterbeort -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Sterbeort</summary>
      <div id="filterSterbeort" class="mt-2 space-y-1"></div>
    </details>

    <!-- Sterbedatum (Spanne) -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Sterbedatum (Jahre)</summary>
      <div class="mt-2">
        <label>von</label>
        <input id="deathYearMin" type="number" class="w-full border rounded p-1 mb-2">
        <label>bis</label>
        <input id="deathYearMax" type="number" class="w-full border rounded p-1">
      </div>
    </details>

    <!-- Geburtsort -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Geburtsort</summary>
      <div id="filterGeburtsort" class="mt-2 space-y-1"></div>
    </details>

    <!-- Geburtsdatum (Spanne) -->
    <details class="mb-4">
      <summary class="cursor-pointer font-medium">Geburtsdatum (Jahre)</summary>
      <div class="mt-2">
        <label>von</label>
        <input id="birthYearMin" type="number" class="w-full border rounded p-1 mb-2">
        <label>bis</label>
        <input id="birthYearMax" type="number" class="w-full border rounded p-1">
      </div>
    </details>

  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6">

    <h1 class="text-3xl font-bold mb-6 text-pink-600">Personenlexikon Schleswig-Holstein</h1>

    <!-- Search -->
    <input id="searchInput" type="text" placeholder="Suche nach Name, Ort ..."
           class="w-full md:w-1/2 px-4 py-2 rounded-xl border border-gray-300 mb-6" />

    <!-- Card Container -->
    <div id="cardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"></div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow rounded-xl overflow-hidden">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 text-left">Name</th>
            <th class="px-4 py-2 text-left">Geburtsjahr</th>
            <th class="px-4 py-2 text-left">Geburtsort</th>
            <th class="px-4 py-2 text-left">Sterbejahr</th>
            <th class="px-4 py-2 text-left">Sterbeort</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Map -->
    <div id="map" class="w-full h-96 my-10 rounded-xl shadow"></div>

  </main>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const csvUrl = "data.csv";
let data = [];
let activeFilters = {
  sterbeorte: new Set(),
  geburtsorte: new Set(),
  deathMin: null,
  deathMax: null,
  birthMin: null,
  birthMax: null,
  search: ""
};

// Load CSV
Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    data = results.data;

    createFacetFilters();
    applyFilters();
  }
});

// Extract unique values and create facet checkboxes
function createFacetFilters() {
  const sterbeortDiv = document.getElementById("filterSterbeort");
  const geburtsortDiv = document.getElementById("filterGeburtsort");

  // Unique sorted lists
  const sterbeorte = [...new Set(data.map(d => d.Sterbeort).filter(Boolean))].sort();
  const geburtsorte = [...new Set(data.map(d => d.Geburtsort).filter(Boolean))].sort();

  sterbeorte.forEach(o => {
    sterbeortDiv.innerHTML += `<label><input type="checkbox" value="${o}" class="sterbeortCB"> ${o}</label><br>`;
  });
  geburtsorte.forEach(o => {
    geburtsortDiv.innerHTML += `<label><input type="checkbox" value="${o}" class="geburtsortCB"> ${o}</label><br>`;
  });

  // Checkboxes
  document.querySelectorAll(".sterbeortCB").forEach(cb =>
    cb.addEventListener("change", () => {
      cb.checked ? activeFilters.sterbeorte.add(cb.value) : activeFilters.sterbeorte.delete(cb.value);
      applyFilters();
    })
  );

  document.querySelectorAll(".geburtsortCB").forEach(cb =>
    cb.addEventListener("change", () => {
      cb.checked ? activeFilters.geburtsorte.add(cb.value) : activeFilters.geburtsorte.delete(cb.value);
      applyFilters();
    })
  );

  // Range inputs
  document.getElementById("deathYearMin").addEventListener("input", e => { activeFilters.deathMin = e.target.value; applyFilters(); });
  document.getElementById("deathYearMax").addEventListener("input", e => { activeFilters.deathMax = e.target.value; applyFilters(); });

  document.getElementById("birthYearMin").addEventListener("input", e => { activeFilters.birthMin = e.target.value; applyFilters(); });
  document.getElementById("birthYearMax").addEventListener("input", e => { activeFilters.birthMax = e.target.value; applyFilters(); });

  document.getElementById("searchInput").addEventListener("input", e => {
    activeFilters.search = e.target.value.toLowerCase();
    applyFilters();
  });
}

function applyFilters() {
  let rows = data.filter(row => {

    // SEARCH
    if (activeFilters.search) {
      const s = activeFilters.search;
      if (!Object.values(row).some(v => String(v).toLowerCase().includes(s))) return false;
    }

    // Sterbeorte
    if (activeFilters.sterbeorte.size > 0 &&
        !activeFilters.sterbeorte.has(row.Sterbeort)) return false;

    // Geburtsorte
    if (activeFilters.geburtsorte.size > 0 &&
        !activeFilters.geburtsorte.has(row.Geburtsort)) return false;

    // Sterbejahre
    const deathYear = row.Sterbedatum ? parseInt(row.Sterbedatum.substring(0,4)) : null;
    if (activeFilters.deathMin && deathYear < activeFilters.deathMin) return false;
    if (activeFilters.deathMax && deathYear > activeFilters.deathMax) return false;

    // Geburtsjahre
    const birthYear = row.Geburtstag ? parseInt(row.Geburtstag.substring(0,4)) : null;
    if (activeFilters.birthMin && birthYear < activeFilters.birthMin) return false;
    if (activeFilters.birthMax && birthYear > activeFilters.birthMax) return false;

    return true;
  });

  renderCards(rows);
  renderTable(rows);
  renderMap(rows);
}

// Render CARD VIEW
function renderCards(rows) {
  document.getElementById("cardContainer").innerHTML = rows.map(row => `
    <div class="bg-white p-4 shadow rounded-xl text-blue-800">
      <h2 class="text-xl font-semibold mb-2">${row.Name}</h2>
      <p><strong>Geburtstag:</strong> ${row.Geburtstag}</p>
      <p><strong>Geburtsort:</strong> ${row.Geburtsort}</p>
      <p><strong>Sterbedatum:</strong> ${row.Sterbedatum}</p>
      <p><strong>Sterbeort:</strong> ${row.Sterbeort}</p>
      <p class="mt-2 text-sm text-gray-700">${row.Biografie || ""}</p>
    </div>`).join('');
}

// Table
function renderTable(rows) {
  document.getElementById("tableBody").innerHTML = rows.map(r => `
    <tr class="border-b">
      <td class="px-4 py-2">${r.Name}</td>
      <td class="px-4 py-2">${r.Geburtstag}</td>
      <td class="px-4 py-2">${r.Geburtsort}</td>
      <td class="px-4 py-2">${r.Sterbedatum}</td>
      <td class="px-4 py-2">${r.Sterbeort}</td>
    </tr>`).join('');
}

// Map
const map = L.map('map').setView([54.5, 9.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

async function geocode(place) {
  if (!place) return null;
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place + ', Germany')}`;
  const r = await fetch(url);
  const d = await r.json();
  return d[0] ? [parseFloat(d[0].lat), parseFloat(d[0].lon)] : null;
}

async function renderMap(rows) {
  map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });

  for (const row of rows) {
    const birth = await geocode(row.Geburtsort);
    if (birth) L.marker(birth).addTo(map).bindPopup(`<b>${row.Name}</b><br>Geburtsort: ${row.Geburtsort}`);

    const death = await geocode(row.Sterbeort);
    if (death) L.marker(death).addTo(map).bindPopup(`<b>${row.Name}</b><br>Sterbeort: ${row.Sterbeort}`);
  }
}
</script>

</body>
</html>
